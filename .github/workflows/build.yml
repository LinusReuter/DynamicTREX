name: Build Verification

on:
  push:
    branches: [main, master, develop, arm]
  pull_request:
    branches: [main, master, develop, arm]

jobs:
  build-linux-x86:
    name: Linux x86_64 (GCC ${{ matrix.gcc }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        gcc: [13, 14]
    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            g++-${{ matrix.gcc }} \
            make \
            libtbb-dev \
            libatomic1 \
            libnuma-dev \
            libgomp1

      - name: Build TREXRelease
        working-directory: Runnables
        run: |
          make TREXRelease \
            CC="g++-${{ matrix.gcc }} -fopenmp" \
            HOMEBREW_PREFIX="" \
            MACOS_FLAGS=""

      - name: Build NetworkRelease
        working-directory: Runnables
        run: |
          make NetworkRelease \
            CC="g++-${{ matrix.gcc }} -fopenmp" \
            HOMEBREW_PREFIX="" \
            MACOS_FLAGS=""

      - name: Smoke test
        working-directory: Runnables
        run: |
          ls -lh TREX Network
          file TREX
          file Network

      - name: Clean
        working-directory: Runnables
        run: make clean

      - name: Build TREXDebug (with -Werror)
        working-directory: Runnables
        run: |
          make TREXDebug \
            CC="g++-${{ matrix.gcc }} -fopenmp" \
            HOMEBREW_PREFIX="" \
            MACOS_FLAGS=""

  build-linux-arm64:
    name: Linux ARM64 (GCC)
    runs-on: ubuntu-24.04-arm
    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            g++ \
            make \
            libtbb-dev \
            libatomic1 \
            libnuma-dev \
            libgomp1

      - name: Build TREXRelease
        working-directory: Runnables
        run: |
          make TREXRelease \
            CC="g++ -fopenmp" \
            HOMEBREW_PREFIX="" \
            MACOS_FLAGS=""

      - name: Build NetworkRelease
        working-directory: Runnables
        run: |
          make NetworkRelease \
            CC="g++ -fopenmp" \
            HOMEBREW_PREFIX="" \
            MACOS_FLAGS=""

      - name: Smoke test
        working-directory: Runnables
        run: |
          ls -lh TREX Network
          file TREX
          file Network

      - name: Clean
        working-directory: Runnables
        run: make clean

      - name: Build TREXDebug (with -Werror)
        working-directory: Runnables
        run: |
          make TREXDebug \
            CC="g++ -fopenmp" \
            HOMEBREW_PREFIX="" \
            MACOS_FLAGS=""
